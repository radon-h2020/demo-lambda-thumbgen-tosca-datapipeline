  ##########################################################################
  # Copyright (c) 2019 Contributors to the RADON project
  #
  # Licensed under the Apache License, Version 2.0 (the "License");
  # you may not use this file except in compliance with the License.
  # You may obtain a copy of the License at
  #
  #     http://www.apache.org/licenses/LICENSE-2.0
  #
  # Unless required by applicable law or agreed to in writing, software
  # distributed under the License is distributed on an "AS IS" BASIS,
  # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  # See the License for the specific language governing permissions and
  # limitations under the License.
  ##########################################################################


---
- hosts: all
## INPUTs are
#        output_port_name: "KafkaOut"
#        source_group_id: "2d8dc669-88d4-3582-1c7e-f9662f705f10"
#        input_port_name: "testl"
#        destination_group_id: "016d1013-b6c7-1d3b-f921-c9002ba2d930" 
 
  vars: 
    root_id_query: "resources[?name=='NiFi Flow' && starts_with(identifier, '/process-groups/')].identifier"
    query_input_port: "resources[?name=='{{input_port_name}}' && starts_with(identifier, '/input-ports/')].identifier"
    query_output_port: "resources[?name=='{{output_port_name}}' && starts_with(identifier, '/output-ports/')].identifier"
  tasks:
    - name: Get list of available NiFi resources for fetching the ids of root reource group, input port and output port
      uri:
        url: http://localhost:8080/nifi-api/resources
        method: GET
      register: nifi_resources 
    # REMOVE: the following task shuld be remove once the relationship in xopera starts working
    - name: get the source group id using output port name {{output_port_name}}
      vars:
        source_identifier: "{{ nifi_resources.json  | to_json | from_json | json_query(query_output_port) | first}}"
      uri:
        url: http://localhost:8080/nifi-api/output-ports/{{source_identifier.split('/')[2]}}
        method: GET
      register: source_identifier_info 
      # the source group id is {{source_identifier_info.component.parentGroupId}}

    # REMOVE: the following task shuld be remove once the relationship in xopera starts working
    - name: get the destination group id using input port name {{input_port_name}}
      vars:
        dest_identifier: "{{ nifi_resources.json  | to_json | from_json | json_query(query_input_port) | first}}"
      uri:
        url: http://localhost:8080/nifi-api/input-ports/{{dest_identifier.split('/')[2]}}
        method: GET
      register: dest_identifier_info 
      # the destination group id is {{dest_identifier_info.component.parentGroupId}}

    - name: create NiFi connection  
      vars:
        source_identifier: "{{ nifi_resources.json  | to_json | from_json | json_query(query_output_port) | first}}"
        destination_identifier: "{{ nifi_resources.json  | to_json | from_json | json_query(query_input_port) | first}}"
        root_identifier: "{{ nifi_resources.json  | to_json | from_json | json_query(root_id_query) | first}}"
      uri:
        url: http://localhost:8080/nifi-api/process-groups/{{root_identifier.split('/')[2]}}/connections
        method: POST
        body:
          "revision": 
             "version": 0
          "component":
            "name": ""
            "source": 
                "id": "{{source_identifier.split('/')[2]}}"
                "groupId": "{{source_identifier_info.json.component.parentGroupId}}"
                # "groupId": "{{source_group_id}}"
                "type": "OUTPUT_PORT"
            "destination": 
                "id": "{{destination_identifier.split('/')[2]}}"
                "groupId": "{{dest_identifier_info.json.component.parentGroupId}}"
                # "groupId": "{{destination_group_id}}"
                "type": "INPUT_PORT"            
        status_code: 201
        body_format: json

    - name: restart the source process group (this will start the output port of the source process group)
      vars:
        source_identifier: "{{ nifi_resources.json  | to_json | from_json | json_query(query_output_port) | first}}"
      uri:
        url: "http://localhost:8080/nifi-api/flow/process-groups/{{source_identifier_info.json.component.parentGroupId}}"
        method: PUT
        body:
          "id": "{{source_identifier_info.json.component.parentGroupId}}"
          "state": "RUNNING" 
        status_code: 201
        body_format: json

